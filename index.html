<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Client-side Proxy دانشگاه</title>

  <!-- کتابخانه برای گرفتن اسکرین‌شات از صفحه -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

  <style>
    body, html {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: auto;
      direction: rtl;
      font-family: sans-serif;
    }
    #toolbar {
      position: fixed; top: 10px; left: 10px; z-index: 9999;
      background: #333; color: #fff; padding: 5px; border-radius: 3px;
    }
    #btnScreenshot {
      margin-left: 5px; padding: 5px; cursor: pointer;
    }
    #content {
      margin-top: 50px; /* کمی فاصله از بالا برای نمایش toolbar */
      padding: 10px;
    }
    #telegramMessage {
      position: fixed; bottom: 10px; right: 10px; 
      background: #222; color: #fff; padding: 5px; border-radius: 3px;
      opacity: 0.9; display: none; z-index: 9999;
    }
  </style>
</head>
<body>

  <div id="toolbar">
    آدرس سایت دانشگاه:
    <input type="text" id="univURL" value="https://site-daneshgah.com" style="width:300px">
    <button onclick="loadUniversity()">بارگیری</button>
    <button id="btnScreenshot">اسکرین‌شات و ارسال تلگرام</button>
  </div>

  <div id="content">
    <!-- اینجا محتوای سایت دانشگاه را نمایش می‌دهیم -->
  </div>

  <div id="telegramMessage"></div>

  <script>
    // توکن و چت‌آیدی تلگرام
    const TOKEN = "توکن‌خودت";
    const CHAT_ID = "چت‌آی‌دی‌خودت";

    let lastUpdateId = 0;

    // این تابع محتوای HTML سایت دانشگاه را به شکل متن می‌گیرد و در #content قرار می‌دهد
    function loadUniversity(){
      let url = document.getElementById("univURL").value.trim();

      // درخواست fetch مستقیماً از مرورگر به سایت دانشگاه می‌رود
      fetch(url)
      .then(response => response.text())
      .then(html => {
        // محتوای دریافتی را در content درون‌ریزی می‌کنیم
        document.getElementById("content").innerHTML = html;

        // حالا می‌توانیم یک ترفند base بگذاریم که لینک‌های داخل html درست کار کنند
        // البته در عمل ممکن است نیاز به اعمال تغییر در لینک‌ها باشد
        let base = document.createElement("base");
        base.href = url; // تعیین مرجع
        document.head.appendChild(base);
      })
      .catch(err => {
        alert("خطا در بارگیری سایت دانشگاه: " + err);
      });
    }

    // تابع گرفتن اسکرین‌شات و ارسال به تلگرام
    function takeScreenshotAndSend(){
      html2canvas(document.body).then(canvas => {
        canvas.toBlob(blob => {
          let fd = new FormData();
          fd.append('chat_id', CHAT_ID);
          fd.append('photo', blob, 'screenshot.png');
          fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, {
            method: 'POST',
            body: fd
          })
          .then(() => alert("اسکرین‌شات ارسال شد!"))
          .catch(err => alert("خطا در ارسال اسکرین‌شات: " + err));
        });
      });
    }

    // تابع دریافت پیام جدید از تلگرام
    function fetchTelegramMessages(){
      fetch(`https://api.telegram.org/bot${TOKEN}/getUpdates?offset=${lastUpdateId+1}`)
      .then(r => r.json())
      .then(data => {
        if(data.ok && data.result.length > 0){
          data.result.forEach(update => {
            if(update.message && update.message.text){
              lastUpdateId = update.update_id;
              showTelegramMessage(update.message.text);
            }
          });
        }
      })
      .catch(err => console.error("خطا در دریافت پیام تلگرام:", err));
    }

    // نمایش پیام دریافتی در #telegramMessage
    function showTelegramMessage(msg){
      const divMsg = document.getElementById('telegramMessage');
      divMsg.innerText = msg;
      divMsg.style.display = 'block';
      setTimeout(()=>{ divMsg.style.display='none'; }, 3000);
    }

    // تنظیم دکمه اسکرین‌شات
    document.getElementById("btnScreenshot").onclick = takeScreenshotAndSend;

    // هر چند ثانیه پیام‌های تلگرام را چک می‌کنیم
    setInterval(fetchTelegramMessages, 3000);
  </script>
</body>
</html>
